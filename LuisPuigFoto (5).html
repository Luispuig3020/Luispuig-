<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Luis Puig FotografÃ­a</title>

<!-- PWA inline - no external files needed -->
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjogIkx1aXMgUHVpZyBGb3RvZ3JhZlx1MDBlZGEiLCAic2hvcnRfbmFtZSI6ICJMUCBGb3RvIiwgInN0YXJ0X3VybCI6ICIuIiwgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwOTA5MDkiLCAidGhlbWVfY29sb3IiOiAiI0M5QTg0QyIsICJpY29ucyI6IFt7InNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBMU1USWdOVEV5SWo0S0lDQThjbVZqZENCM2FXUjBhRDBpTlRFeUlpQm9aV2xuYUhROUlqVXhNaUlnY25nOUlqZ3dJaUJtYVd4c1BTSWpNRGt3T1RBNUlpOCtDaUFnUEhCdmJIbG5iMjRnY0c5cGJuUnpQU0l5TlRZc05UQWdORFl3TERRek1DQTFNaXcwTXpBaUlHWnBiR3c5SW01dmJtVWlJSE4wY205clpUMGlJME01UVRnMFF5SWdjM1J5YjJ0bExYZHBaSFJvUFNJeU9DSWdjM1J5YjJ0bExXeHBibVZxYjJsdVBTSnliM1Z1WkNJdlBnb2dJRHh3YjJ4NVoyOXVJSEJ2YVc1MGN6MGlNalUyTERFM01DQXpOalFzTXprMUlERTBPQ3d6T1RVaUlHWnBiR3c5SW01dmJtVWlJSE4wY205clpUMGlJelkyTmlJZ2MzUnliMnRsTFhkcFpIUm9QU0l4TmlJZ2MzUnliMnRsTFd4cGJtVnFiMmx1UFNKeWIzVnVaQ0l2UGdvOEwzTjJaejQ9IiwgInNpemVzIjogIjUxMng1MTIiLCAidHlwZSI6ICJpbWFnZS9zdmcreG1sIiwgInB1cnBvc2UiOiAiYW55IG1hc2thYmxlIn1dfQ==">
<meta name="theme-color" content="#C9A84C">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="LP Foto">
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj4KICA8cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjgwIiBmaWxsPSIjMDkwOTA5Ii8+CiAgPHBvbHlnb24gcG9pbnRzPSIyNTYsNTAgNDYwLDQzMCA1Miw0MzAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI0M5QTg0QyIgc3Ryb2tlLXdpZHRoPSIyOCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgogIDxwb2x5Z29uIHBvaW50cz0iMjU2LDE3MCAzNjQsMzk1IDE0OCwzOTUiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzY2NiIgc3Ryb2tlLXdpZHRoPSIxNiIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4=">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj4KICA8cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjgwIiBmaWxsPSIjMDkwOTA5Ii8+CiAgPHBvbHlnb24gcG9pbnRzPSIyNTYsNTAgNDYwLDQzMCA1Miw0MzAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI0M5QTg0QyIgc3Ryb2tlLXdpZHRoPSIyOCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgogIDxwb2x5Z29uIHBvaW50cz0iMjU2LDE3MCAzNjQsMzk1IDE0OCwzOTUiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzY2NiIgc3Ryb2tlLXdpZHRoPSIxNiIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4=">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --au:#C9A84C;--au2:#E8C97A;--au3:#9A7A30;
  --bg:#090909;--s1:#151515;--s2:#1D1D1D;--s3:#262626;
  --tx:#EDE9E3;--mu:#6B6B6B;
  --vd:#4EAB78;--ro:#D95050;--az:#4A8ED4;--rs:#C46FA8;--na:#D4893A;--am:#C8A830;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Montserrat',sans-serif;background:var(--bg);color:var(--tx);max-width:430px;margin:0 auto;min-height:100vh;}

/* HEADER */
#hdr{background:linear-gradient(150deg,#1A1200,#090909);padding:14px 14px 10px;border-bottom:1px solid rgba(201,168,76,.12);position:sticky;top:0;z-index:300;}
.hrow{display:flex;align-items:center;justify-content:space-between;}
.logo{display:flex;align-items:center;gap:9px;}
.brand b{font-family:'Cormorant Garamond',serif;font-size:14px;color:var(--au);letter-spacing:1.5px;display:block;}
.brand small{font-size:7px;letter-spacing:3px;color:var(--mu);text-transform:uppercase;}
#hdate{font-size:10px;color:var(--mu);text-align:right;line-height:1.6;}

/* TABS */
#tabs{display:flex;gap:5px;padding:10px 12px 0;overflow-x:auto;scrollbar-width:none;background:var(--bg);}
#tabs::-webkit-scrollbar{display:none;}
.tab{flex-shrink:0;padding:7px 13px;border-radius:20px;border:1px solid rgba(201,168,76,.2);background:transparent;color:var(--mu);font-family:'Montserrat',sans-serif;font-size:10px;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;transition:.2s;}
.tab.on{background:var(--au);border-color:var(--au);color:#000;font-weight:600;}

/* SECTIONS */
.sec{display:none;padding:12px 12px 90px;}
.sec.on{display:block;}
.stitle{font-family:'Cormorant Garamond',serif;font-size:24px;font-weight:300;color:var(--au2);margin-bottom:14px;}

/* CARD */
.card{background:var(--s2);border-radius:14px;border:1px solid rgba(255,255,255,.05);padding:14px;margin-bottom:12px;}
.ctitle{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--au);margin-bottom:12px;}

/* FORM */
.fg{margin-bottom:10px;}
.fg label{display:block;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--mu);margin-bottom:4px;}
.fg input,.fg select,.fg textarea{width:100%;background:var(--s3);border:1px solid rgba(201,168,76,.2);border-radius:9px;padding:10px 12px;color:var(--tx);font-family:'Montserrat',sans-serif;font-size:13px;outline:none;transition:.2s;}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--au);}
.fg select option{background:var(--s3);}
.fg textarea{resize:vertical;min-height:60px;}
.fg input[readonly]{opacity:.5;cursor:not-allowed;}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:9px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}

/* BUTTONS */
.btn{width:100%;padding:12px;border-radius:11px;border:none;font-family:'Montserrat',sans-serif;font-size:11px;letter-spacing:2px;text-transform:uppercase;font-weight:600;cursor:pointer;transition:.15s;}
.btn:active{transform:scale(.97);}
.btn-au{background:linear-gradient(135deg,var(--au),var(--au3));color:#000;}
.btn-sm{width:auto;padding:7px 12px;font-size:9px;}
.btn-out{background:transparent;border:1px solid rgba(201,168,76,.3);color:var(--au);}
.btn-ro{background:rgba(217,80,80,.1);border:1px solid rgba(217,80,80,.3);color:var(--ro);}
.btn-vd{background:rgba(78,171,120,.1);border:1px solid rgba(78,171,120,.3);color:var(--vd);}
.btn-az{background:rgba(74,142,212,.1);border:1px solid rgba(74,142,212,.3);color:var(--az);}

/* ITEMS */
.item{background:var(--s2);border-radius:13px;border:1px solid rgba(255,255,255,.05);margin-bottom:9px;padding:13px 14px;position:relative;overflow:hidden;}
.item::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;}
.t-comunion::before{background:var(--au);}
.t-embarazo::before{background:var(--rs);}
.t-bautizo::before{background:var(--az);}
.t-boda::before{background:var(--vd);}
.t-bebes::before{background:var(--na);}
.t-navidad::before{background:var(--ro);}
.t-ingreso::before{background:var(--vd);}
.t-senal::before{background:var(--am);}
.t-gasto::before{background:var(--ro);}
.t-pendiente::before{background:var(--na);}
.t-nota-alta::before{background:var(--ro);}
.t-nota-media::before{background:var(--am);}
.t-nota-baja::before{background:var(--az);}
.t-nota-hecha::before{background:var(--mu);}

.irow{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;}
.iname{font-weight:600;font-size:14px;margin-bottom:3px;}
.isub{font-size:11px;color:var(--mu);line-height:1.6;}
.iright{text-align:right;flex-shrink:0;}
.price{font-family:'Cormorant Garamond',serif;font-size:20px;}
.pos{color:var(--vd);}.neg{color:var(--ro);}.warn{color:var(--na);}.yel{color:var(--am);}

.badge{display:inline-block;font-size:8px;letter-spacing:1px;text-transform:uppercase;padding:3px 8px;border-radius:7px;margin-top:3px;}
.bg-comunion{background:rgba(201,168,76,.15);color:var(--au);}
.bg-embarazo{background:rgba(196,111,168,.15);color:var(--rs);}
.bg-bautizo{background:rgba(74,142,212,.15);color:var(--az);}
.bg-boda{background:rgba(78,171,120,.15);color:var(--vd);}
.bg-bebes{background:rgba(212,137,58,.15);color:var(--na);}
.bg-navidad{background:rgba(217,80,80,.15);color:var(--ro);}
.bg-ingreso{background:rgba(78,171,120,.15);color:var(--vd);}
.bg-senal{background:rgba(200,168,48,.15);color:var(--am);}
.bg-gasto{background:rgba(217,80,80,.15);color:var(--ro);}
.bg-pendiente{background:rgba(212,137,58,.15);color:var(--na);}
.bg-alta{background:rgba(217,80,80,.15);color:var(--ro);}
.bg-media{background:rgba(200,168,48,.15);color:var(--am);}
.bg-baja{background:rgba(74,142,212,.15);color:var(--az);}
.bg-hecha{background:rgba(107,107,107,.15);color:var(--mu);}

.iact{display:flex;gap:7px;margin-top:10px;flex-wrap:wrap;}

/* PAGO BAR */
.pbar{margin-top:9px;padding-top:9px;border-top:1px solid rgba(255,255,255,.06);}
.pbar-row{display:flex;justify-content:space-between;font-size:10px;color:var(--mu);margin-bottom:4px;}
.pbar-track{height:5px;background:var(--s3);border-radius:3px;overflow:hidden;}
.pbar-fill{height:100%;background:linear-gradient(90deg,var(--vd),var(--au));transition:.4s;}
.pbar-st{font-size:10px;margin-top:4px;}

/* SUMMARY GRID */
.sg2{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;}
.sbox{background:var(--s3);border-radius:11px;padding:11px 12px;}
.sbox .sl{font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--mu);margin-bottom:4px;}
.sbox .sv{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:600;}
.sv-vd{color:var(--vd);}.sv-ro{color:var(--ro);}.sv-na{color:var(--na);}.sv-az{color:var(--az);}
.stotal{background:linear-gradient(135deg,rgba(201,168,76,.1),rgba(201,168,76,.03));border:1px solid rgba(201,168,76,.15);border-radius:11px;padding:11px 14px;display:flex;justify-content:space-between;align-items:center;}
.stotal span{font-size:10px;color:var(--mu);letter-spacing:1px;text-transform:uppercase;}
.stotal .stv{font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:600;}

/* MES SELECTOR */
.msel{display:flex;align-items:center;justify-content:space-between;background:var(--s2);border-radius:11px;padding:9px 13px;margin-bottom:12px;}
.msel span{font-size:13px;font-weight:500;}
.mbtn{background:transparent;border:none;color:var(--au);font-size:22px;cursor:pointer;padding:0 6px;line-height:1;}

/* SEP */
.sep{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--mu);margin:14px 0 9px;padding-bottom:6px;border-bottom:1px solid rgba(255,255,255,.06);}

/* FILTERS */
.frow{display:flex;gap:6px;margin-bottom:12px;overflow-x:auto;scrollbar-width:none;}
.frow::-webkit-scrollbar{display:none;}
.fbtn{flex-shrink:0;padding:6px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.1);background:transparent;color:var(--mu);font-size:10px;letter-spacing:1px;text-transform:uppercase;cursor:pointer;font-family:'Montserrat',sans-serif;transition:.2s;}
.fbtn.on{background:var(--s2);border-color:rgba(201,168,76,.35);color:var(--tx);}

/* MODAL */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:500;align-items:flex-end;justify-content:center;}
.overlay.on{display:flex;}
.modal{background:var(--s2);border-radius:20px 20px 0 0;padding:18px;width:100%;max-width:430px;border-top:1px solid rgba(201,168,76,.2);max-height:88vh;overflow-y:auto;}
.modal h3{font-family:'Cormorant Garamond',serif;font-size:21px;color:var(--au2);margin-bottom:14px;}
.mact{display:flex;gap:9px;margin-top:14px;}
.mact .btn{flex:1;}

/* TOAST */
#toast{position:fixed;top:70px;left:50%;transform:translateX(-50%);background:var(--s2);border:1px solid rgba(201,168,76,.3);color:var(--tx);padding:10px 18px;border-radius:11px;font-size:12px;z-index:1000;opacity:0;transition:opacity .3s;pointer-events:none;white-space:nowrap;max-width:90vw;text-align:center;}
#toast.on{opacity:1;}

/* ALARMA banner */
#alarm-banner{display:none;position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#7A0000,#C00);z-index:999;padding:14px 16px;max-width:430px;margin:0 auto;}
#alarm-banner h4{font-size:13px;font-weight:600;margin-bottom:4px;}
#alarm-banner p{font-size:11px;opacity:.85;}
#alarm-close{position:absolute;top:10px;right:14px;background:transparent;border:none;color:#fff;font-size:20px;cursor:pointer;line-height:1;}

/* TARIFA */
.tg{margin-bottom:18px;}
.tg h3{font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--au);margin-bottom:9px;}
.titem{background:var(--s2);border-radius:11px;border:1px solid rgba(255,255,255,.05);padding:13px 14px;margin-bottom:7px;display:flex;justify-content:space-between;align-items:center;gap:10px;}
.titem h4{font-size:13px;font-weight:600;margin-bottom:2px;}
.titem p{font-size:11px;color:var(--mu);}
.tprice{font-family:'Cormorant Garamond',serif;font-size:22px;color:var(--au2);flex-shrink:0;}

/* EMPTY */
.empty{text-align:center;padding:28px 16px;color:var(--mu);font-size:12px;}
.empty .ei{font-size:30px;margin-bottom:6px;opacity:.4;}

/* INFOBOX */
.ibox{background:var(--s2);border-radius:11px;padding:13px 14px;border:1px solid rgba(201,168,76,.14);margin-bottom:8px;}
.ibox .il{font-size:11px;color:var(--au);font-weight:600;margin-bottom:5px;}
.ibox .ic{font-size:12px;color:var(--mu);line-height:1.7;}

/* SEARCH */
.search{width:100%;background:var(--s2);border:1px solid rgba(201,168,76,.2);border-radius:9px;padding:10px 12px;color:var(--tx);font-family:'Montserrat',sans-serif;font-size:13px;outline:none;margin-bottom:12px;}
.search:focus{border-color:var(--au);}

/* ALARMA badge en nota */
.alarm-badge{display:inline-block;background:rgba(217,80,80,.15);color:var(--ro);font-size:8px;padding:2px 7px;border-radius:6px;margin-left:5px;letter-spacing:1px;}
</style>
</head>
<body>

<!-- ALARMA BANNER -->
<div id="alarm-banner">
  <button id="alarm-close" onclick="closeAlarm()">âœ•</button>
  <h4 id="alarm-title">â° Recordatorio</h4>
  <p id="alarm-body"></p>
</div>

<!-- TOAST -->
<div id="toast"></div>

<!-- HEADER -->
<div id="hdr">
  <div class="hrow">
    <div class="logo">
      <svg width="30" height="30" viewBox="0 0 100 100" fill="none">
        <polygon points="50,5 95,85 5,85" stroke="#C9A84C" stroke-width="7" fill="none" stroke-linejoin="round"/>
        <polygon points="50,30 78,80 22,80" stroke="#888" stroke-width="4" fill="none" stroke-linejoin="round"/>
      </svg>
      <div class="brand"><b>LUIS PUIG</b><small>FotografÃ­a</small></div>
    </div>
    <div id="hdate"></div>
    <button onclick="abrirVoz()" style="background:linear-gradient(135deg,var(--au),var(--au3));border:none;border-radius:50%;width:34px;height:34px;font-size:16px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;" title="Comando de voz">ğŸ¤</button>
    <button id="install-btn" onclick="instalarPWA()" style="display:none;background:linear-gradient(135deg,#4A8ED4,#2A6EA4);border:none;border-radius:50%;width:34px;height:34px;font-size:16px;cursor:pointer;flex-shrink:0;align-items:center;justify-content:center;" title="Instalar app">ğŸ“²</button>
  </div>
</div>

<!-- TABS -->
<div id="tabs">
  <button class="tab on"  onclick="go('resumen',this)">ğŸ“Š Resumen</button>
  <button class="tab"     onclick="go('agenda',this)">ğŸ“… Agenda</button>
  <button class="tab"     onclick="go('finanzas',this)">ğŸ’° Finanzas</button>
  <button class="tab"     onclick="go('clientes',this)">ğŸ‘¥ Clientes</button>
  <button class="tab"     onclick="go('notas',this)">ğŸ“ Notas</button>
  <button class="tab"     onclick="go('tarifas',this)">ğŸ“‹ Tarifas</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESUMEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="sec on" id="sec-resumen">
  <p class="stitle">Panel general</p>

  <div class="card">
    <div class="ctitle">ğŸ’° Totales acumulados</div>
    <div class="sg2">
      <div class="sbox"><div class="sl">Total cobrado</div><div class="sv sv-vd" id="R-ing">0â‚¬</div></div>
      <div class="sbox"><div class="sl">Total gastos</div><div class="sv sv-ro"  id="R-gas">0â‚¬</div></div>
      <div class="sbox"><div class="sl">Por cobrar</div><div class="sv sv-na"   id="R-pen">0â‚¬</div></div>
      <div class="sbox"><div class="sl">NÂº clientes</div><div class="sv sv-az"  id="R-cli">0</div></div>
    </div>
    <div class="stotal">
      <span>Beneficio neto</span>
      <span class="stv" id="R-ben">0â‚¬</span>
    </div>
  </div>

  <div class="card">
    <div class="ctitle" id="R-mestit">ğŸ“… Este mes</div>
    <div class="sg2">
      <div class="sbox"><div class="sl">Ingresos mes</div><div class="sv sv-vd" id="R-ming">0â‚¬</div></div>
      <div class="sbox"><div class="sl">Gastos mes</div><div class="sv sv-ro"   id="R-mgas">0â‚¬</div></div>
      <div class="sbox"><div class="sl">SeÃ±ales mes</div><div class="sv sv-az"  id="R-msen">0â‚¬</div></div>
      <div class="sbox"><div class="sl">Citas mes</div><div class="sv sv-na"    id="R-mcit">0</div></div>
    </div>
  </div>

  <div class="sep">âš ï¸ NOTAS URGENTES</div>
  <div id="R-urgentes"></div>

  <div class="sep">ğŸ“… PRÃ“XIMAS CITAS</div>
  <div id="R-proximas"></div>

  <div class="sep">ğŸŸ  COBROS PENDIENTES</div>
  <div id="R-pendientes"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AGENDA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="sec" id="sec-agenda">
  <p class="stitle">Agenda de citas</p>
  <div class="card">
    <div class="ctitle">â• Nueva cita</div>
    <div class="g2">
      <div class="fg"><label>Nombre cliente</label><input id="A_nom" type="text" placeholder="MarÃ­a GarcÃ­a"></div>
      <div class="fg"><label>TelÃ©fono</label><input id="A_tel" type="tel" placeholder="620..."></div>
    </div>
    <div class="g2">
      <div class="fg"><label>Servicio</label>
        <select id="A_tipo">
          <option value="comunion">ComuniÃ³n</option>
          <option value="embarazo">Embarazo</option>
          <option value="bautizo">Bautizo</option>
          <option value="boda">Boda / Preboda</option>
          <option value="bebes">BebÃ©s</option>
          <option value="navidad">Navidad</option>
        </select>
      </div>
      <div class="fg"><label>Pack</label>
        <select id="A_pack" onchange="packAuto('A_pack','A_total','A_senal','A_resto')">
          <option value="0">Sin especificar</option>
          <option value="90">Pack Bronce â€“ 90â‚¬</option>
          <option value="145">Pack Plata â€“ 145â‚¬</option>
          <option value="210">Pack Oro â€“ 210â‚¬</option>
          <option value="80">Pack Recuerdo â€“ 80â‚¬</option>
          <option value="120a">Pack Historia â€“ 120â‚¬</option>
          <option value="120b">Pack Esencial â€“ 120â‚¬</option>
          <option value="190">Pack CelebraciÃ³n â€“ 190â‚¬</option>
          <option value="custom">Otro (manual)</option>
        </select>
      </div>
    </div>
    <div class="g3">
      <div class="fg"><label>Total sesiÃ³n â‚¬</label><input id="A_total" type="number" min="0" placeholder="0" oninput="recalc('A_total','A_senal','A_resto')"></div>
      <div class="fg"><label>SeÃ±al cobrada â‚¬</label><input id="A_senal" type="number" min="0" placeholder="0" oninput="recalc('A_total','A_senal','A_resto')"></div>
      <div class="fg"><label>Resto pendiente</label><input id="A_resto" type="number" min="0" placeholder="0" readonly></div>
    </div>
    <div class="g2">
      <div class="fg"><label>Fecha</label><input id="A_fecha" type="date"></div>
      <div class="fg"><label>Hora</label><input id="A_hora" type="time"></div>
    </div>
    <div class="fg"><label>Lugar</label><input id="A_lugar" type="text" placeholder="JardÃ­n Canario, Maspalomas..."></div>
    <div class="fg"><label>Notas</label><textarea id="A_notas" placeholder="Detalles especiales..."></textarea></div>
    <button class="btn btn-au" onclick="addCita()">Guardar cita</button>
  </div>

  <div class="frow">
    <button class="fbtn on" onclick="filtCita('todas',this)">Todas</button>
    <button class="fbtn"    onclick="filtCita('comunion',this)">ComuniÃ³n</button>
    <button class="fbtn"    onclick="filtCita('embarazo',this)">Embarazo</button>
    <button class="fbtn"    onclick="filtCita('bautizo',this)">Bautizo</button>
    <button class="fbtn"    onclick="filtCita('boda',this)">Boda</button>
    <button class="fbtn"    onclick="filtCita('bebes',this)">BebÃ©s</button>
  </div>
  <div id="L-citas"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FINANZAS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="sec" id="sec-finanzas">
  <p class="stitle">Finanzas</p>

  <div class="msel">
    <button class="mbtn" onclick="chgMonth(-1)">â€¹</button>
    <span id="F-meslbl">â€”</span>
    <button class="mbtn" onclick="chgMonth(1)">â€º</button>
  </div>

  <!-- Resumen mes -->
  <div class="card">
    <div class="ctitle" id="F-mestit">Resumen del mes</div>
    <div class="sg2">
      <div class="sbox"><div class="sl">Ingresos</div><div class="sv sv-vd" id="F-ing">0â‚¬</div></div>
      <div class="sbox"><div class="sl">Gastos</div><div class="sv sv-ro"   id="F-gas">0â‚¬</div></div>
      <div class="sbox"><div class="sl">SeÃ±ales</div><div class="sv sv-az"  id="F-sen">0â‚¬</div></div>
      <div class="sbox"><div class="sl">Beneficio</div><div class="sv"      id="F-ben">0â‚¬</div></div>
    </div>
  </div>

  <!-- Formulario manual -->
  <div class="card">
    <div class="ctitle">â• AÃ±adir movimiento</div>
    <div class="g2">
      <div class="fg"><label>Tipo</label>
        <select id="F_tipo">
          <option value="ingreso">ğŸ’š Ingreso cobrado</option>
          <option value="senal">ğŸŸ¡ SeÃ±al recibida</option>
          <option value="pendiente">ğŸŸ  Resto pendiente</option>
          <option value="gasto">ğŸ”´ Gasto</option>
        </select>
      </div>
      <div class="fg"><label>Importe â‚¬</label><input id="F_imp" type="number" min="0" placeholder="0"></div>
    </div>
    <div class="fg"><label>Concepto</label><input id="F_concepto" type="text" placeholder="Ej: SeÃ±al sesiÃ³n MarÃ­a G."></div>
    <div class="g2">
      <div class="fg"><label>Fecha</label><input id="F_fecha" type="date"></div>
      <div class="fg"><label>Cliente</label><input id="F_cli" type="text" placeholder="Nombre"></div>
    </div>
    <button class="btn btn-au" onclick="addFin()">Guardar movimiento</button>
  </div>

  <div class="sep">MOVIMIENTOS DEL MES</div>
  <div id="L-fin"></div>

  <div class="sep">ğŸŸ  COBROS PENDIENTES (todos)</div>
  <div id="L-pend"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CLIENTES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="sec" id="sec-clientes">
  <p class="stitle">Clientes</p>
  <div class="card">
    <div class="ctitle">â• Nuevo cliente</div>
    <div class="g2">
      <div class="fg"><label>Nombre</label><input id="C_nom" type="text" placeholder="Nombre completo"></div>
      <div class="fg"><label>TelÃ©fono</label><input id="C_tel" type="tel" placeholder="620..."></div>
    </div>
    <div class="g2">
      <div class="fg"><label>Servicio</label>
        <select id="C_tipo">
          <option value="comunion">ComuniÃ³n</option>
          <option value="embarazo">Embarazo</option>
          <option value="bautizo">Bautizo</option>
          <option value="boda">Boda</option>
          <option value="bebes">BebÃ©s</option>
          <option value="navidad">Navidad</option>
        </select>
      </div>
      <div class="fg"><label>Pack</label>
        <select id="C_pack" onchange="packAuto('C_pack','C_total','C_senal','C_resto')">
          <option value="0">Sin especificar</option>
          <option value="90">Pack Bronce â€“ 90â‚¬</option>
          <option value="145">Pack Plata â€“ 145â‚¬</option>
          <option value="210">Pack Oro â€“ 210â‚¬</option>
          <option value="80">Pack Recuerdo â€“ 80â‚¬</option>
          <option value="120a">Pack Historia â€“ 120â‚¬</option>
          <option value="120b">Pack Esencial â€“ 120â‚¬</option>
          <option value="190">Pack CelebraciÃ³n â€“ 190â‚¬</option>
          <option value="custom">Otro (manual)</option>
        </select>
      </div>
    </div>
    <div class="g3">
      <div class="fg"><label>Total sesiÃ³n â‚¬</label><input id="C_total" type="number" min="0" placeholder="0" oninput="recalc('C_total','C_senal','C_resto')"></div>
      <div class="fg"><label>SeÃ±al cobrada â‚¬</label><input id="C_senal" type="number" min="0" placeholder="0" oninput="recalc('C_total','C_senal','C_resto')"></div>
      <div class="fg"><label>Resto pendiente</label><input id="C_resto" type="number" min="0" placeholder="0" readonly></div>
    </div>
    <div class="fg"><label>Notas</label><textarea id="C_notas" placeholder="Detalles, preferencias..."></textarea></div>
    <button class="btn btn-au" onclick="addCliente()">Guardar cliente</button>
  </div>
  <input class="search" id="C_buscar" type="text" placeholder="ğŸ” Buscar cliente..." oninput="renderClientes()">
  <div id="L-cli"></div>
</div>

<!-- NOTAS -->
<div class="sec" id="sec-notas">
  <p class="stitle">Notas y recordatorios</p>

  <div style="background:linear-gradient(135deg,rgba(217,80,80,.1),rgba(201,168,76,.07));border:1px solid rgba(217,80,80,.22);border-radius:13px;padding:13px 14px;margin-bottom:12px;display:flex;align-items:flex-start;gap:10px;">
    <div style="font-size:22px;">â°</div>
    <div>
      <div style="font-size:11px;font-weight:600;color:var(--au2);margin-bottom:5px;letter-spacing:.5px;">CÃ“MO CREAR UN RECORDATORIO CON ALARMA</div>
      <div style="font-size:11px;color:var(--mu);line-height:1.8;">
        1. Escribe el tÃ­tulo de lo que tienes que recordar<br>
        2. Pon la <b style="color:var(--tx)">ğŸ“… Fecha alarma</b> en que quieres que suene<br>
        3. Pon la <b style="color:var(--tx)">ğŸ• Hora exacta</b> de la alarma<br>
        4. Pulsa <b style="color:var(--au)">Guardar recordatorio</b><br>
        <span style="color:var(--ro)">â†’ A esa hora aparecerÃ¡ una alerta roja en pantalla</span>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="ctitle">â• Nueva nota / recordatorio</div>
    <div class="fg">
      <label>ğŸ“Œ TÃ­tulo â€” Â¿quÃ© tienes que hacer?</label>
      <input id="N_tit" type="text" placeholder="Ej: Llamar a MarÃ­a para confirmar sesiÃ³n">
    </div>
    <div class="fg">
      <label>ğŸ“ DescripciÃ³n (opcional)</label>
      <textarea id="N_desc" placeholder="MÃ¡s detalles..."></textarea>
    </div>

    <div style="background:rgba(217,80,80,.07);border:1px solid rgba(217,80,80,.2);border-radius:11px;padding:12px;margin-bottom:10px;">
      <div style="font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--ro);margin-bottom:10px;">â° ALARMA â€” CUÃNDO AVISARTE</div>
      <div class="g2">
        <div class="fg" style="margin-bottom:0">
          <label>ğŸ“… Fecha de alarma</label>
          <input id="N_fecha" type="date">
        </div>
        <div class="fg" style="margin-bottom:0">
          <label>ğŸ• Hora exacta</label>
          <input id="N_hora" type="time">
        </div>
      </div>
      <p style="font-size:10px;color:var(--mu);margin-top:8px;text-align:center;">Si no pones hora, no habrÃ¡ alarma</p>
    </div>

    <div class="fg">
      <label>ğŸš¦ Prioridad</label>
      <select id="N_prio">
        <option value="alta">ğŸ”´ Alta â€“ Urgente</option>
        <option value="media" selected>ğŸŸ¡ Media</option>
        <option value="baja">ğŸ”µ Baja</option>
      </select>
    </div>
    <button class="btn btn-au" onclick="addNota()">â° Guardar recordatorio</button>
  </div>

  <div class="frow">
    <button class="fbtn on" onclick="filtNota('todas',this)">Todas</button>
    <button class="fbtn"    onclick="filtNota('pend',this)">Pendientes</button>
    <button class="fbtn"    onclick="filtNota('alta',this)">ğŸ”´ Urgentes</button>
    <button class="fbtn"    onclick="filtNota('hecha',this)">âœ… Hechas</button>
  </div>
  <div id="L-notas"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TARIFAS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="sec" id="sec-tarifas">
  <p class="stitle">Mis tarifas</p>

  <!-- AÃ±adir tarifa -->
  <div class="card">
    <div class="ctitle">â• AÃ±adir / editar tarifa</div>
    <div class="g2">
      <div class="fg"><label>Nombre del pack</label><input id="T_nom" type="text" placeholder="Ej: Pack Premium"></div>
      <div class="fg"><label>Precio â‚¬</label><input id="T_precio" type="number" min="0" placeholder="0"></div>
    </div>
    <div class="fg"><label>DescripciÃ³n</label><input id="T_desc" type="text" placeholder="Ej: 2h Â· 100 fotos Â· Ãlbum"></div>
    <div class="fg"><label>CategorÃ­a</label>
      <select id="T_cat">
        <option value="comunion">ğŸ“¸ ComuniÃ³n</option>
        <option value="embarazo">ğŸ¤° Embarazo</option>
        <option value="bautizo">ğŸ•Šï¸ Bautizo</option>
        <option value="boda">ğŸ’ Boda</option>
        <option value="bebes">ğŸ‘¶ BebÃ©s</option>
        <option value="navidad">ğŸ„ Navidad</option>
        <option value="extras">âœ¨ Extras</option>
      </select>
    </div>
    <button class="btn btn-au" onclick="addTarifa()">Guardar tarifa</button>
  </div>

  <div id="L-tarifas"></div>

  <div class="ibox"><div class="il">ğŸ’³ PAGO</div><div class="ic">60% al contratar Â· 40% el dÃ­a de la sesiÃ³n</div></div>
  <div class="ibox" style="margin-top:8px"><div class="il">ğŸ“ CONTACTO</div><div class="ic">WhatsApp: <a href="tel:620890554" style="color:var(--au);text-decoration:none">620 890 554</a><br>Instagram: @luispuigfotografia</div></div>
</div>

<!-- MODAL VOZ -->
<div class="overlay" id="modal-voz">
  <div class="modal">
    <h3>ğŸ¤ Comando de voz</h3>
    <div id="voz-instruc" style="background:var(--s3);border-radius:11px;padding:13px;margin-bottom:14px;font-size:12px;color:var(--mu);line-height:1.8;">
      Habla con naturalidad. Ejemplos:<br>
      <span style="color:var(--au)">Â«Cita para MarÃ­a GarcÃ­a, comuniÃ³n Pack Plata, el 15 de marzo a las 10 de la maÃ±anaÂ»</span><br>
      <span style="color:var(--au)">Â«Nuevo cliente Ana LÃ³pez, embarazo, seÃ±al 60 eurosÂ»</span><br>
      <span style="color:var(--au)">Â«Ingreso de 145 euros, comuniÃ³n de SofÃ­aÂ»</span><br>
      <span style="color:var(--au)">Â«Recordatorio llamar al cliente el 20 de marzo a las 9Â»</span><br><br>
      <span style="color:var(--am);font-size:10px;">âš ï¸ Requiere Chrome (Android/PC) o Safari (iPhone). Acepta el permiso del micrÃ³fono cuando te lo pida.</span>
    </div>

    <!-- BotÃ³n micrÃ³fono -->
    <div style="text-align:center;margin-bottom:14px;">
      <button id="voz-btn" onclick="toggleVoz()" style="width:80px;height:80px;border-radius:50%;border:3px solid var(--au);background:var(--s3);cursor:pointer;font-size:32px;transition:.2s;display:inline-flex;align-items:center;justify-content:center;">ğŸ¤</button>
      <div id="voz-estado" style="font-size:11px;color:var(--mu);margin-top:8px;letter-spacing:1px;">PULSA PARA HABLAR</div>
    </div>

    <!-- TranscripciÃ³n -->
    <div id="voz-texto-wrap" style="display:none;margin-bottom:12px;">
      <div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--mu);margin-bottom:6px;">Has dicho:</div>
      <div id="voz-texto" style="background:var(--s3);border-radius:9px;padding:11px 13px;font-size:13px;color:var(--tx);line-height:1.5;min-height:44px;"></div>
    </div>

    <!-- Resultado IA -->
    <div id="voz-result-wrap" style="display:none;margin-bottom:12px;">
      <div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--vd);margin-bottom:6px;">âœ… He entendido:</div>
      <div id="voz-result" style="background:rgba(78,171,120,.08);border:1px solid rgba(78,171,120,.2);border-radius:9px;padding:11px 13px;font-size:12px;color:var(--tx);line-height:1.7;"></div>
    </div>

    <div id="voz-loading" style="display:none;text-align:center;padding:16px;color:var(--mu);font-size:12px;">â³ Procesando con IA...</div>
    <div id="voz-error" style="display:none;background:rgba(217,80,80,.1);border:1px solid rgba(217,80,80,.2);border-radius:9px;padding:11px 13px;font-size:12px;color:var(--ro);margin-bottom:12px;"></div>

    <div class="mact" id="voz-acciones" style="display:none;">
      <button class="btn btn-ro" onclick="vozRechazar()">âœ— Cancelar</button>
      <button class="btn btn-au" onclick="vozAceptar()">âœ“ Confirmar y guardar</button>
    </div>
    <button class="btn btn-out" onclick="closeModal('modal-voz')" style="margin-top:9px;">Cerrar</button>
  </div>
</div>

<!-- MODAL EDITAR CITA -->
<div class="overlay" id="modal-cita">
  <div class="modal">
    <h3>Editar cita</h3>
    <input type="hidden" id="EC_id">
    <input type="hidden" id="EC_total">
    <div class="g2">
      <div class="fg"><label>Nombre</label><input id="EC_nom" type="text"></div>
      <div class="fg"><label>TelÃ©fono</label><input id="EC_tel" type="tel"></div>
    </div>
    <div class="g2">
      <div class="fg"><label>Fecha</label><input id="EC_fecha" type="date"></div>
      <div class="fg"><label>Hora</label><input id="EC_hora" type="time"></div>
    </div>
    <div class="g2">
      <div class="fg"><label>SeÃ±al cobrada â‚¬</label><input id="EC_senal" type="number" oninput="recalcModal()"></div>
      <div class="fg"><label>Resto pendiente</label><input id="EC_resto" type="number" readonly></div>
    </div>
    <div class="fg"><label>Lugar</label><input id="EC_lugar" type="text"></div>
    <div class="fg"><label>Notas</label><textarea id="EC_notas"></textarea></div>
    <div class="mact">
      <button class="btn btn-ro" onclick="closeModal('modal-cita')">Cancelar</button>
      <button class="btn btn-au" onclick="saveCita()">Guardar</button>
    </div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BASE DE DATOS (localStorage)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var KEY = 'lpv3';
var DB = { citas:[], fin:[], clientes:[], notas:[], tarifas:null };

function loadDB() {
  var raw = localStorage.getItem(KEY);
  if (raw) {
    try { DB = JSON.parse(raw); } catch(e) {}
  }
  DB.citas    = DB.citas    || [];
  DB.fin      = DB.fin      || [];
  DB.clientes = DB.clientes || [];
  DB.notas    = DB.notas    || [];
  DB.tarifas  = DB.tarifas  || null;
}

function saveDB() {
  localStorage.setItem(KEY, JSON.stringify(DB));
}

/* ID Ãºnico: timestamp + contador incremental */
var _idCounter = 0;
function uid() {
  _idCounter++;
  return Date.now() * 1000 + _idCounter;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ESTADO UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var curM = new Date().getMonth();
var curY = new Date().getFullYear();
var filtCitaVal = 'todas';
var filtNotaVal = 'todas';
var alarmTimer  = null;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function init() {
  loadDB();
  getTarifas(); // Inicializar tarifas si no existen
  var now = new Date();
  document.getElementById('hdate').innerHTML =
    now.toLocaleDateString('es-ES',{weekday:'short',day:'numeric',month:'short'}).toUpperCase();
  document.getElementById('A_fecha').valueAsDate = now;
  document.getElementById('F_fecha').valueAsDate = now;
  document.getElementById('N_fecha').valueAsDate = now;
  rebuildPackSelects();
  updMonthLabel();
  renderAll();
  startAlarmCheck();
}

function renderAll() {
  renderResumen();
  renderCitas();
  renderFin();
  renderClientes();
  renderNotas();
  renderTarifas();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function go(sec, btn) {
  document.querySelectorAll('.sec').forEach(function(s){ s.classList.remove('on'); });
  document.querySelectorAll('.tab').forEach(function(t){ t.classList.remove('on'); });
  document.getElementById('sec-'+sec).classList.add('on');
  btn.classList.add('on');
}

function toast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('on');
  setTimeout(function(){ t.classList.remove('on'); }, 2800);
}

function closeModal(id) { document.getElementById(id).classList.remove('on'); }
document.querySelectorAll('.overlay').forEach(function(el){
  el.addEventListener('click', function(e){ if(e.target===el) el.classList.remove('on'); });
});

function hoy() { return new Date().toISOString().split('T')[0]; }

function fmtD(d) {
  if (!d) return '';
  return new Date(d+'T12:00:00').toLocaleDateString('es-ES',{weekday:'short',day:'numeric',month:'short'});
}

function sameM(fecha, m, y) {
  if (!fecha) return false;
  var d = new Date(fecha+'T12:00:00');
  return d.getMonth()===m && d.getFullYear()===y;
}

var SVCS = {comunion:'ComuniÃ³n',embarazo:'Embarazo',bautizo:'Bautizo',boda:'Boda',bebes:'BebÃ©s',navidad:'Navidad'};
function svcL(t) { return SVCS[t] || t; }

var FINS = {ingreso:'Ingreso',senal:'SeÃ±al',gasto:'Gasto',pendiente:'Pendiente'};
function finL(t) { return FINS[t] || t; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PACK AUTO-FILL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var PACK_PRICES = {'90':90,'145':145,'210':210,'80':80,'120a':120,'120b':120,'190':190,'custom':0,'0':0};

function packAuto(packId, totId, senId, resId) {
  var v = document.getElementById(packId).value;
  var p = PACK_PRICES[v] || 0;
  if (p > 0) {
    document.getElementById(totId).value = p;
    recalc(totId, senId, resId);
  }
}

function recalc(tId, sId, rId) {
  var t = parseFloat(document.getElementById(tId).value) || 0;
  var s = parseFloat(document.getElementById(sId).value) || 0;
  document.getElementById(rId).value = Math.max(0, t-s);
}

function recalcModal() {
  var t = parseFloat(document.getElementById('EC_total').value) || 0;
  var s = parseFloat(document.getElementById('EC_senal').value) || 0;
  document.getElementById('EC_resto').value = Math.max(0, t-s);
}

function clr() {
  var ids = Array.prototype.slice.call(arguments);
  ids.forEach(function(id){
    var el=document.getElementById(id);
    if(el){ el.value=''; }
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAY BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function pbarHTML(total, senal, resto) {
  if (!total || total <= 0) return '';
  var pct = Math.min(100, Math.round((senal/total)*100));
  return '<div class="pbar">'+
    '<div class="pbar-row"><span>Cobrado: '+senal+'â‚¬</span><span>Total: '+total+'â‚¬</span></div>'+
    '<div class="pbar-track"><div class="pbar-fill" style="width:'+pct+'%"></div></div>'+
    '<div class="pbar-st" style="color:'+(resto>0?'var(--na)':'var(--vd)')+'">'+
      (resto>0 ? 'â³ Pendiente cobrar: '+resto+'â‚¬' : 'âœ… Pagado completo')+
    '</div></div>';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTO-REGISTRO FINANCIERO
   Llamar DESPUÃ‰S de push en DB.citas/clientes
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function autoFin(nombre, svcNombre, total, senal, resto) {
  /*
    LÃ³gica:
    - senal > 0 y resto === 0  â†’ ingreso cobrado total
    - senal > 0 y resto > 0    â†’ seÃ±al cobrada + pendiente de cobrar
    - senal === 0 y total > 0  â†’ todo pendiente
    - total === 0              â†’ nada que registrar
  */
  if (total <= 0 && senal <= 0) return;
  var h = hoy();

  if (senal > 0 && resto === 0) {
    // Pago completo de una sola vez
    DB.fin.push({ id:uid(), tipo:'ingreso', imp:senal,
      concepto:'Cobro total '+svcNombre+' â€“ '+nombre, fecha:h, cliente:nombre });
  } else if (senal > 0 && resto > 0) {
    // Pago parcial
    DB.fin.push({ id:uid(), tipo:'senal', imp:senal,
      concepto:'SeÃ±al '+svcNombre+' â€“ '+nombre, fecha:h, cliente:nombre });
    DB.fin.push({ id:uid(), tipo:'pendiente', imp:resto,
      concepto:'Resto '+svcNombre+' â€“ '+nombre, fecha:h, cliente:nombre });
  } else if (senal === 0 && total > 0) {
    // Sin seÃ±al, todo pendiente
    DB.fin.push({ id:uid(), tipo:'pendiente', imp:total,
      concepto:'Pago pendiente '+svcNombre+' â€“ '+nombre, fecha:h, cliente:nombre });
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESUMEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderResumen() {
  var now=new Date(), m=now.getMonth(), y=now.getFullYear();

  // Acumulados totales (ingreso + senal = dinero recibido)
  var totIng = DB.fin.filter(function(f){ return f.tipo==='ingreso'||f.tipo==='senal'; })
                     .reduce(function(a,f){ return a+f.imp; },0);
  var totGas = DB.fin.filter(function(f){ return f.tipo==='gasto'; })
                     .reduce(function(a,f){ return a+f.imp; },0);
  var totPen = DB.fin.filter(function(f){ return f.tipo==='pendiente'; })
                     .reduce(function(a,f){ return a+f.imp; },0);
  var ben = totIng - totGas;

  set('R-ing', totIng+'â‚¬');
  set('R-gas', totGas+'â‚¬');
  set('R-pen', totPen+'â‚¬');
  set('R-cli', DB.clientes.length);
  var bEl = document.getElementById('R-ben');
  bEl.textContent = ben+'â‚¬';
  bEl.style.color = ben>=0?'var(--vd)':'var(--ro)';

  // Mes actual
  var mIng = DB.fin.filter(function(f){ return f.tipo==='ingreso'&&sameM(f.fecha,m,y); }).reduce(function(a,f){ return a+f.imp; },0);
  var mGas = DB.fin.filter(function(f){ return f.tipo==='gasto'  &&sameM(f.fecha,m,y); }).reduce(function(a,f){ return a+f.imp; },0);
  var mSen = DB.fin.filter(function(f){ return f.tipo==='senal'  &&sameM(f.fecha,m,y); }).reduce(function(a,f){ return a+f.imp; },0);
  var mCit = DB.citas.filter(function(c){ return sameM(c.fecha,m,y); }).length;
  set('R-ming', mIng+'â‚¬'); set('R-mgas', mGas+'â‚¬'); set('R-msen', mSen+'â‚¬'); set('R-mcit', mCit);
  set('R-mestit', 'ğŸ“… '+new Date(y,m,1).toLocaleDateString('es-ES',{month:'long',year:'numeric'}));

  // Urgentes
  var urg = DB.notas.filter(function(n){ return n.prio==='alta'&&n.estado!=='hecha'; }).slice(0,4);
  var uEl = document.getElementById('R-urgentes');
  uEl.innerHTML = urg.length ? urg.map(function(n){
    return '<div class="item t-nota-alta" style="margin-bottom:8px">'+
      '<div class="irow"><div>'+
      '<div class="iname">'+n.tit+'</div>'+
      '<div class="isub">'+(n.fecha?'ğŸ“… '+fmtD(n.fecha)+(n.hora?' Â· â° '+n.hora:''):'')+'</div>'+
      '</div><span class="badge bg-alta">Urgente</span></div></div>';
  }).join('') : '<div class="empty"><div class="ei">âœ…</div>Sin urgentes</div>';

  // PrÃ³ximas citas
  var h = hoy();
  var prox = DB.citas.filter(function(c){ return c.fecha>=h; })
                     .sort(function(a,b){ return a.fecha.localeCompare(b.fecha); }).slice(0,4);
  var pEl = document.getElementById('R-proximas');
  pEl.innerHTML = prox.length ? prox.map(function(c){
    return '<div class="item t-'+c.tipo+'" style="margin-bottom:8px">'+
      '<div class="irow"><div>'+
      '<div class="iname">'+c.nombre+'</div>'+
      '<div class="isub">ğŸ“… '+fmtD(c.fecha)+(c.hora?' Â· â° '+c.hora:'')+(c.lugar?'<br>ğŸ“ '+c.lugar:'')+'</div>'+
      '</div><span class="badge bg-'+c.tipo+'">'+svcL(c.tipo)+'</span></div></div>';
  }).join('') : '<div class="empty"><div class="ei">ğŸ“…</div>Sin citas prÃ³ximas</div>';

  // Cobros pendientes
  var pend = DB.fin.filter(function(f){ return f.tipo==='pendiente'; });
  var peEl = document.getElementById('R-pendientes');
  peEl.innerHTML = pend.length ? pend.slice(0,5).map(function(f){
    return '<div class="item t-pendiente" style="margin-bottom:8px">'+
      '<div class="irow"><div>'+
      '<div class="iname">'+f.concepto+'</div>'+
      '<div class="isub">'+(f.cliente||'')+'</div>'+
      '</div><div class="price warn">'+f.imp+'â‚¬</div></div></div>';
  }).join('') : '<div class="empty"><div class="ei">âœ…</div>Sin cobros pendientes</div>';
}

function set(id, val) { var el=document.getElementById(id); if(el) el.textContent=val; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updMonthLabel() {
  var lbl = new Date(curY,curM,1).toLocaleDateString('es-ES',{month:'long',year:'numeric'}).toUpperCase();
  set('F-meslbl', lbl);
  set('F-mestit', 'Resumen â€” '+lbl);
  renderFin();
}
function chgMonth(d) {
  curM += d;
  if (curM>11){ curM=0; curY++; }
  if (curM<0) { curM=11; curY--; }
  updMonthLabel();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CITAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addCita() {
  var nom = document.getElementById('A_nom').value.trim();
  var fecha = document.getElementById('A_fecha').value;
  if (!nom||!fecha) { toast('âš ï¸ Nombre y fecha obligatorios'); return; }

  var tipo  = document.getElementById('A_tipo').value;
  var total = parseFloat(document.getElementById('A_total').value)||0;
  var senal = parseFloat(document.getElementById('A_senal').value)||0;
  var resto = Math.max(0, total-senal);
  var packV = document.getElementById('A_pack').value;
  var packNames = {'90':'Pack Bronce','145':'Pack Plata','210':'Pack Oro','80':'Pack Recuerdo','120a':'Pack Historia','120b':'Pack Esencial','190':'Pack CelebraciÃ³n','custom':'','0':''};
  var pack = packNames[packV]||'';

  // 1. Guardar cita
  DB.citas.push({ id:uid(), nombre:nom,
    tel:document.getElementById('A_tel').value,
    tipo:tipo, pack:pack, total:total, senal:senal, resto:resto, fecha:fecha,
    hora:document.getElementById('A_hora').value,
    lugar:document.getElementById('A_lugar').value,
    notas:document.getElementById('A_notas').value });

  // 2. AUTO-REGISTRAR EN FINANZAS (garantizado)
  autoFin(nom, svcL(tipo), total, senal, resto);

  // 3. Guardar y renderizar
  saveDB(); renderAll();
  toast('âœ… Cita guardada Â· apuntes creados en Finanzas');
  clr('A_nom','A_tel','A_hora','A_lugar','A_notas','A_total','A_senal','A_resto');
  document.getElementById('A_pack').value='0';
}

function filtCita(f, btn) {
  filtCitaVal=f;
  document.querySelectorAll('#sec-agenda .fbtn').forEach(function(b){ b.classList.remove('on'); });
  btn.classList.add('on'); renderCitas();
}

function renderCitas() {
  var cont = document.getElementById('L-citas');
  var list = DB.citas.slice().sort(function(a,b){ return a.fecha.localeCompare(b.fecha); });
  if (filtCitaVal!=='todas') list=list.filter(function(c){ return c.tipo===filtCitaVal; });
  if (!list.length){ cont.innerHTML='<div class="empty"><div class="ei">ğŸ“…</div>No hay citas</div>'; return; }
  cont.innerHTML = list.map(function(c){
    var t=c.total||0,s=c.senal||0,r=c.resto||0;
    return '<div class="item t-'+c.tipo+'">'+
      '<div class="irow"><div>'+
      '<div class="iname">'+c.nombre+'</div>'+
      '<div class="isub">ğŸ“… '+fmtD(c.fecha)+(c.hora?' Â· â° '+c.hora:'')+(c.lugar?'<br>ğŸ“ '+c.lugar:'')+(c.pack?'<br>ğŸ“¦ '+c.pack:'')+'</div>'+
      '</div><span class="badge bg-'+c.tipo+'">'+svcL(c.tipo)+'</span></div>'+
      pbarHTML(t,s,r)+
      (c.notas?'<div style="font-size:11px;color:var(--mu);margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,.05)">ğŸ“ '+c.notas+'</div>':'')+
      (c.tel?'<div style="font-size:11px;margin-top:6px"><a href="tel:'+c.tel+'" style="color:var(--au);text-decoration:none">ğŸ“ '+c.tel+'</a></div>':'')+
      '<div class="iact">'+
        (r>0?'<button class="btn btn-vd btn-sm" onclick="cobrarRestoCita('+c.id+')">âœ… Cobrar resto</button>':'')+
        '<button class="btn btn-out btn-sm" onclick="editCita('+c.id+')">Editar</button>'+
        '<button class="btn btn-ro btn-sm" onclick="delCita('+c.id+')">Anular</button>'+
      '</div></div>';
  }).join('');
}

function cobrarRestoCita(id) {
  var idx=DB.citas.findIndex(function(c){ return c.id===id; }); if(idx===-1)return;
  var c=DB.citas[idx];
  if(c.resto<=0)return;
  // Registrar ingreso
  DB.fin.push({ id:uid(), tipo:'ingreso', imp:c.resto,
    concepto:'Resto '+svcL(c.tipo)+' â€“ '+c.nombre, fecha:hoy(), cliente:c.nombre });
  // Eliminar pendiente exacto
  var done=false;
  DB.fin=DB.fin.filter(function(f){
    if(!done && f.tipo==='pendiente' && f.cliente===c.nombre && f.imp===c.resto){ done=true; return false; }
    return true;
  });
  DB.citas[idx].senal=c.total; DB.citas[idx].resto=0;
  saveDB(); renderAll(); toast('âœ… Resto cobrado y registrado como ingreso');
}

function editCita(id) {
  var c=DB.citas.find(function(x){ return x.id===id; }); if(!c)return;
  document.getElementById('EC_id').value=id;
  document.getElementById('EC_total').value=c.total||0;
  document.getElementById('EC_nom').value=c.nombre;
  document.getElementById('EC_tel').value=c.tel||'';
  document.getElementById('EC_fecha').value=c.fecha;
  document.getElementById('EC_hora').value=c.hora||'';
  document.getElementById('EC_senal').value=c.senal||0;
  document.getElementById('EC_resto').value=c.resto||0;
  document.getElementById('EC_lugar').value=c.lugar||'';
  document.getElementById('EC_notas').value=c.notas||'';
  document.getElementById('modal-cita').classList.add('on');
}

function saveCita() {
  var id=parseInt(document.getElementById('EC_id').value);
  var idx=DB.citas.findIndex(function(x){ return x.id===id; }); if(idx===-1)return;
  var total=DB.citas[idx].total||0;
  var senal=parseFloat(document.getElementById('EC_senal').value)||0;
  Object.assign(DB.citas[idx],{
    nombre:document.getElementById('EC_nom').value,
    tel:document.getElementById('EC_tel').value,
    fecha:document.getElementById('EC_fecha').value,
    hora:document.getElementById('EC_hora').value,
    senal:senal, resto:Math.max(0,total-senal),
    lugar:document.getElementById('EC_lugar').value,
    notas:document.getElementById('EC_notas').value
  });
  saveDB(); renderAll(); closeModal('modal-cita'); toast('âœ… Cita actualizada');
}

function delCita(id) {
  if(!confirm('Â¿Anular esta cita?'))return;
  DB.citas=DB.citas.filter(function(c){ return c.id!==id; });
  saveDB(); renderAll(); toast('ğŸ—‘ï¸ Cita anulada');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FINANZAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addFin() {
  var concepto=document.getElementById('F_concepto').value.trim();
  var imp=parseFloat(document.getElementById('F_imp').value);
  if(!concepto||!imp||imp<=0){ toast('âš ï¸ Concepto e importe obligatorios'); return; }
  DB.fin.push({ id:uid(), tipo:document.getElementById('F_tipo').value, imp:imp,
    concepto:concepto, fecha:document.getElementById('F_fecha').value,
    cliente:document.getElementById('F_cli').value });
  saveDB(); renderAll(); toast('âœ… Movimiento guardado');
  clr('F_concepto','F_imp','F_cli');
}

function renderFin() {
  // Movimientos del mes (no pendientes)
  var cont=document.getElementById('L-fin');
  var list=DB.fin.filter(function(f){ return f.tipo!=='pendiente'&&sameM(f.fecha,curM,curY); })
                 .sort(function(a,b){ return b.fecha.localeCompare(a.fecha); });

  var mIng=list.filter(function(f){ return f.tipo==='ingreso'; }).reduce(function(a,f){ return a+f.imp; },0);
  var mGas=list.filter(function(f){ return f.tipo==='gasto';   }).reduce(function(a,f){ return a+f.imp; },0);
  var mSen=list.filter(function(f){ return f.tipo==='senal';   }).reduce(function(a,f){ return a+f.imp; },0);
  var mBen=(mIng+mSen)-mGas;
  set('F-ing',mIng+'â‚¬'); set('F-gas',mGas+'â‚¬'); set('F-sen',mSen+'â‚¬');
  var bEl=document.getElementById('F-ben');
  bEl.textContent=mBen+'â‚¬'; bEl.style.color=mBen>=0?'var(--vd)':'var(--ro)';

  cont.innerHTML = list.length ? list.map(function(f){
    var isPos=f.tipo!=='gasto';
    return '<div class="item t-'+f.tipo+'">'+
      '<div class="irow"><div>'+
      '<div class="iname">'+f.concepto+'</div>'+
      '<div class="isub">'+fmtD(f.fecha)+(f.cliente?' Â· '+f.cliente:'')+'</div>'+
      '</div><div class="iright">'+
      '<div class="price '+(isPos?'pos':'neg')+'">'+(isPos?'+':'-')+f.imp+'â‚¬</div>'+
      '<span class="badge bg-'+f.tipo+'">'+finL(f.tipo)+'</span>'+
      '</div></div>'+
      '<div class="iact"><button class="btn btn-ro btn-sm" onclick="delFin('+f.id+')">Eliminar</button></div>'+
      '</div>';
  }).join('') : '<div class="empty"><div class="ei">ğŸ’°</div>Sin movimientos este mes</div>';

  // Pendientes (todos, sin filtro de mes)
  var pCont=document.getElementById('L-pend');
  var pend=DB.fin.filter(function(f){ return f.tipo==='pendiente'; })
                 .sort(function(a,b){ return a.fecha.localeCompare(b.fecha); });
  pCont.innerHTML = pend.length ? pend.map(function(f){
    return '<div class="item t-pendiente">'+
      '<div class="irow"><div>'+
      '<div class="iname">'+f.concepto+'</div>'+
      '<div class="isub">'+fmtD(f.fecha)+(f.cliente?' Â· '+f.cliente:'')+'</div>'+
      '</div><div class="iright">'+
      '<div class="price warn">'+f.imp+'â‚¬</div>'+
      '<span class="badge bg-pendiente">Pendiente</span>'+
      '</div></div>'+
      '<div class="iact">'+
      '<button class="btn btn-vd btn-sm" onclick="cobrarPend('+f.id+')">âœ… Cobrado</button>'+
      '<button class="btn btn-ro btn-sm" onclick="delFin('+f.id+')">Eliminar</button>'+
      '</div></div>';
  }).join('') : '<div class="empty"><div class="ei">âœ…</div>Sin cobros pendientes</div>';

  renderResumen();
}

function cobrarPend(id) {
  var idx=DB.fin.findIndex(function(f){ return f.id===id; }); if(idx===-1)return;
  DB.fin[idx].tipo='ingreso'; DB.fin[idx].fecha=hoy();
  saveDB(); renderAll(); toast('âœ… Cobro registrado como ingreso');
}

function delFin(id) {
  if(!confirm('Â¿Eliminar movimiento?'))return;
  DB.fin=DB.fin.filter(function(f){ return f.id!==id; });
  saveDB(); renderAll(); toast('ğŸ—‘ï¸ Eliminado');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLIENTES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addCliente() {
  var nom=document.getElementById('C_nom').value.trim();
  if(!nom){ toast('âš ï¸ El nombre es obligatorio'); return; }

  var tipo  = document.getElementById('C_tipo').value;
  var total = parseFloat(document.getElementById('C_total').value)||0;
  var senal = parseFloat(document.getElementById('C_senal').value)||0;
  var resto = Math.max(0,total-senal);
  var packV = document.getElementById('C_pack').value;
  var packNames={'90':'Pack Bronce','145':'Pack Plata','210':'Pack Oro','80':'Pack Recuerdo','120a':'Pack Historia','120b':'Pack Esencial','190':'Pack CelebraciÃ³n','custom':'','0':''};
  var pack=packNames[packV]||'';

  // 1. Guardar cliente
  DB.clientes.push({ id:uid(), nombre:nom,
    tel:document.getElementById('C_tel').value,
    tipo:tipo, pack:pack, total:total, senal:senal, resto:resto,
    notas:document.getElementById('C_notas').value, fecha:hoy() });

  // 2. AUTO-REGISTRAR EN FINANZAS (garantizado)
  autoFin(nom, svcL(tipo), total, senal, resto);

  // 3. Guardar y renderizar
  saveDB(); renderAll();
  toast('âœ… Cliente guardado Â· apuntes creados en Finanzas');
  clr('C_nom','C_tel','C_notas','C_total','C_senal','C_resto');
  document.getElementById('C_pack').value='0';
}

function renderClientes() {
  var cont=document.getElementById('L-cli');
  var buscar=document.getElementById('C_buscar').value.toLowerCase();
  var list=DB.clientes.slice().sort(function(a,b){ return b.id-a.id; });
  if(buscar) list=list.filter(function(c){ return c.nombre.toLowerCase().includes(buscar)||(c.tel||'').includes(buscar); });
  if(!list.length){ cont.innerHTML='<div class="empty"><div class="ei">ğŸ‘¥</div>No hay clientes</div>'; return; }
  cont.innerHTML=list.map(function(c){
    var t=c.total||0,s=c.senal||0,r=c.resto||0;
    return '<div class="item t-'+c.tipo+'">'+
      '<div class="irow"><div>'+
      '<div class="iname">'+c.nombre+'</div>'+
      '<div class="isub">'+
        (c.tel?'<a href="tel:'+c.tel+'" style="color:var(--au);text-decoration:none">ğŸ“ '+c.tel+'</a><br>':'')+
        (c.pack||'')+
      '</div></div>'+
      '<span class="badge bg-'+c.tipo+'">'+svcL(c.tipo)+'</span></div>'+
      pbarHTML(t,s,r)+
      (c.notas?'<div style="font-size:11px;color:var(--mu);margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,.05)">ğŸ“ '+c.notas+'</div>':'')+
      '<div class="iact">'+
        (r>0?'<button class="btn btn-vd btn-sm" onclick="cobrarRestoCliente('+c.id+')">âœ… Cobrar resto</button>':'')+
        '<button class="btn btn-ro btn-sm" onclick="delCli('+c.id+')">Eliminar</button>'+
      '</div></div>';
  }).join('');
}

function cobrarRestoCliente(id) {
  var idx=DB.clientes.findIndex(function(c){ return c.id===id; }); if(idx===-1)return;
  var c=DB.clientes[idx]; if(c.resto<=0)return;
  DB.fin.push({ id:uid(), tipo:'ingreso', imp:c.resto,
    concepto:'Resto '+svcL(c.tipo)+' â€“ '+c.nombre, fecha:hoy(), cliente:c.nombre });
  var done=false;
  DB.fin=DB.fin.filter(function(f){
    if(!done && f.tipo==='pendiente' && f.cliente===c.nombre && f.imp===c.resto){ done=true; return false; }
    return true;
  });
  DB.clientes[idx].senal=c.total; DB.clientes[idx].resto=0;
  saveDB(); renderAll(); toast('âœ… Resto cobrado y registrado como ingreso');
}

function delCli(id) {
  if(!confirm('Â¿Eliminar cliente?'))return;
  DB.clientes=DB.clientes.filter(function(c){ return c.id!==id; });
  saveDB(); renderAll(); toast('ğŸ—‘ï¸ Eliminado');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOTAS CON ALARMA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addNota() {
  var tit=document.getElementById('N_tit').value.trim();
  if(!tit){ toast('âš ï¸ El tÃ­tulo es obligatorio'); return; }
  DB.notas.push({ id:uid(), tit:tit,
    desc:document.getElementById('N_desc').value,
    fecha:document.getElementById('N_fecha').value,
    hora:document.getElementById('N_hora').value,
    prio:document.getElementById('N_prio').value,
    estado:'pend', alarmFired:false });
  saveDB(); renderAll(); toast('âœ… Nota guardada');
  clr('N_tit','N_desc');
}

function filtNota(f, btn) {
  filtNotaVal=f;
  document.querySelectorAll('#sec-notas .fbtn').forEach(function(b){ b.classList.remove('on'); });
  btn.classList.add('on'); renderNotas();
}

function renderNotas() {
  var cont=document.getElementById('L-notas');
  var h=hoy();
  var list=DB.notas.slice().sort(function(a,b){
    var p={alta:0,media:1,baja:2};
    if(a.estado==='hecha'&&b.estado!=='hecha') return 1;
    if(a.estado!=='hecha'&&b.estado==='hecha') return -1;
    return (p[a.prio]||1)-(p[b.prio]||1)||(a.fecha||'').localeCompare(b.fecha||'');
  });
  if(filtNotaVal==='pend')  list=list.filter(function(n){ return n.estado!=='hecha'; });
  if(filtNotaVal==='alta')  list=list.filter(function(n){ return n.prio==='alta'&&n.estado!=='hecha'; });
  if(filtNotaVal==='hecha') list=list.filter(function(n){ return n.estado==='hecha'; });
  if(!list.length){ cont.innerHTML='<div class="empty"><div class="ei">ğŸ“</div>No hay notas</div>'; return; }

  cont.innerHTML=list.map(function(n){
    var hecha=n.estado==='hecha';
    var venc=n.fecha&&n.fecha<h&&!hecha;
    var tieneAlarma=n.fecha&&n.hora;
    var prioBg={alta:'bg-alta',media:'bg-media',baja:'bg-baja'}[n.prio];
    var prioTx={alta:'ğŸ”´ Alta',media:'ğŸŸ¡ Media',baja:'ğŸ”µ Baja'}[n.prio];
    var cls=hecha?'t-nota-hecha':'t-nota-'+n.prio;
    return '<div class="item '+cls+'"'+(hecha?' style="opacity:.5"':'')+'>'+
      '<div class="irow"><div style="flex:1">'+
      '<div class="iname"'+(hecha?' style="text-decoration:line-through"':'')+'>'+n.tit+
        (tieneAlarma?'<span class="alarm-badge">â° alarma</span>':'')+
      '</div>'+
      (n.desc?'<div class="isub">'+n.desc+'</div>':'')+
      (n.fecha?'<div class="isub" style="color:'+(venc?'var(--ro)':'var(--mu)')+'">'+
        'ğŸ“… '+fmtD(n.fecha)+(n.hora?' Â· â° '+n.hora:'')+(venc?' Â· âš ï¸ Vencida':'')+
      '</div>':'')+
      '</div><span class="badge '+prioBg+'">'+prioTx+'</span></div>'+
      '<div class="iact">'+
        (!hecha
          ? '<button class="btn btn-vd btn-sm" onclick="doneNota('+n.id+')">âœ… Hecha</button>'
          : '<button class="btn btn-out btn-sm" onclick="reopenNota('+n.id+')">â†©ï¸ Reabrir</button>'
        )+
        '<button class="btn btn-ro btn-sm" onclick="delNota('+n.id+')">Eliminar</button>'+
      '</div></div>';
  }).join('');
}

function doneNota(id) {
  var idx=DB.notas.findIndex(function(n){ return n.id===id; }); if(idx===-1)return;
  DB.notas[idx].estado='hecha';
  saveDB(); renderAll(); toast('âœ… Nota marcada como hecha');
}
function reopenNota(id) {
  var idx=DB.notas.findIndex(function(n){ return n.id===id; }); if(idx===-1)return;
  DB.notas[idx].estado='pend'; DB.notas[idx].alarmFired=false;
  saveDB(); renderNotas(); toast('â†©ï¸ Nota reabierta');
}
function delNota(id) {
  if(!confirm('Â¿Eliminar nota?'))return;
  DB.notas=DB.notas.filter(function(n){ return n.id!==id; });
  saveDB(); renderAll(); toast('ğŸ—‘ï¸ Nota eliminada');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SISTEMA DE ALARMAS â€” visual + sonido Web Audio
   Comprueba cada 30 seg. Funciona sin permisos
   de notificaciÃ³n del sistema.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startAlarmCheck() {
  checkAlarms();
  setInterval(checkAlarms, 30000);
}

function checkAlarms() {
  var h = hoy();
  var now = new Date();
  var nowHH = String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
  var changed = false;

  DB.notas.forEach(function(n, idx) {
    if (n.estado==='hecha' || n.alarmFired) return;
    if (!n.fecha || !n.hora) return;
    if (n.fecha === h) {
      var diff = toMin(n.hora) - toMin(nowHH);
      // Disparar si la hora ya pasÃ³ o faltan â‰¤1 min
      if (diff <= 1 && diff >= -2) {
        DB.notas[idx].alarmFired = true;
        changed = true;
        showAlarm(n.tit, n.desc, n.fecha, n.hora);
      }
    } else if (n.fecha < h) {
      // Fecha pasada â†’ marcar como fired silenciosamente
      DB.notas[idx].alarmFired = true;
      changed = true;
    }
  });
  if (changed) saveDB();
}

function toMin(hhmm) {
  var p = (hhmm||'0:0').split(':');
  return parseInt(p[0]||0)*60 + parseInt(p[1]||0);
}

function showAlarm(tit, desc, fecha, hora) {
  // 1. Banner visual rojo en pantalla
  document.getElementById('alarm-title').textContent = 'â° ' + tit;
  document.getElementById('alarm-body').textContent  = (desc ? desc + ' Â· ' : '') + fmtD(fecha) + ' a las ' + hora;
  document.getElementById('alarm-banner').style.display = 'block';

  // 2. Sonido con Web Audio API (sin archivos externos, funciona siempre)
  try {
    var ctx = new (window.AudioContext || window.webkitAudioContext)();
    // Toca 3 pitidos cortos
    [0, 0.35, 0.7].forEach(function(t) {
      var osc = ctx.createOscillator();
      var gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.type = 'sine';
      osc.frequency.value = 880;
      gain.gain.setValueAtTime(0, ctx.currentTime + t);
      gain.gain.linearRampToValueAtTime(0.4, ctx.currentTime + t + 0.05);
      gain.gain.linearRampToValueAtTime(0, ctx.currentTime + t + 0.25);
      osc.start(ctx.currentTime + t);
      osc.stop(ctx.currentTime + t + 0.3);
    });
  } catch(e) {}

  // 3. VibraciÃ³n (funciona en Android Chrome)
  if (navigator.vibrate) navigator.vibrate([400, 150, 400, 150, 400]);
}

function closeAlarm() {
  document.getElementById('alarm-banner').style.display = 'none';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TARIFAS EDITABLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var TARIFAS_DEFAULT = [
  {id:1,cat:'comunion',nom:'Pack Bronce',desc:'1h Â· 40 fotos digitales Â· Entrega 10 dÃ­as',precio:90},
  {id:2,cat:'comunion',nom:'Pack Plata',desc:'90min Â· 60 fotos Â· 6 impresas 15x20 Â· Pendrive Â· 15 dÃ­as',precio:145},
  {id:3,cat:'comunion',nom:'Pack Oro',desc:'120min Â· 80 fotos Â· 10 impresas Â· Ãlbum 26p Â· 16 recordatorios',precio:210},
  {id:4,cat:'embarazo',nom:'Pack Recuerdo',desc:'120min Â· 90 fotos alta res Â· GalerÃ­a online privada',precio:80},
  {id:5,cat:'embarazo',nom:'Pack Historia',desc:'180min Â· 120 fotos Â· 10 impresas 15x20 Â· Pendrive',precio:120},
  {id:6,cat:'bautizo',nom:'Pack Esencial',desc:'Ceremonia + fotos familiares Â· 50+ fotos Â· 10 impresas',precio:120},
  {id:7,cat:'bautizo',nom:'Pack CelebraciÃ³n',desc:'Esencial + 2h convite Â· 80+ fotos Â· 10 impresas',precio:190},
  {id:8,cat:'extras',nom:'Cartel CelebraciÃ³n',desc:'85x150cm Â· estructura y bolsa',precio:36},
  {id:9,cat:'extras',nom:'Libro de firma con foto',desc:'31x22cm Â· Tapa dura Â· 20p Kraft',precio:34},
  {id:10,cat:'extras',nom:'Recordatorios 10x15cm',desc:'8 uds Â· 16 uds Â· 24 uds',precio:16},
  {id:11,cat:'extras',nom:'Foto 15x20cm',desc:'ImpresiÃ³n unitaria',precio:3},
  {id:12,cat:'extras',nom:'DÃ­ptico DinA4',desc:'',precio:10},
  {id:13,cat:'extras',nom:'PÃ³ster 50x70cm',desc:'',precio:18},
  {id:14,cat:'extras',nom:'PÃ³ster 100x100cm',desc:'',precio:44}
];

var CAT_LABELS = {
  comunion:'ğŸ“¸ ComuniÃ³n', embarazo:'ğŸ¤° Embarazo', bautizo:'ğŸ•Šï¸ Bautizo',
  boda:'ğŸ’ Boda', bebes:'ğŸ‘¶ BebÃ©s', navidad:'ğŸ„ Navidad', extras:'âœ¨ Extras'
};

function getTarifas() {
  DB.tarifas = DB.tarifas || null;
  if (!DB.tarifas) {
    DB.tarifas = JSON.parse(JSON.stringify(TARIFAS_DEFAULT));
    saveDB();
  }
  return DB.tarifas;
}

function addTarifa() {
  var nom = document.getElementById('T_nom').value.trim();
  var precio = parseFloat(document.getElementById('T_precio').value)||0;
  if (!nom || !precio) { toast('âš ï¸ Nombre y precio obligatorios'); return; }
  getTarifas().push({
    id: uid(),
    cat: document.getElementById('T_cat').value,
    nom: nom,
    desc: document.getElementById('T_desc').value,
    precio: precio
  });
  saveDB(); renderTarifas(); toast('âœ… Tarifa guardada');
  clr('T_nom','T_precio','T_desc');
  // Actualizar selects de pack en agenda y clientes
  rebuildPackSelects();
}

function delTarifa(id) {
  if (!confirm('Â¿Eliminar esta tarifa?')) return;
  DB.tarifas = getTarifas().filter(function(t){ return t.id!==id; });
  saveDB(); renderTarifas(); rebuildPackSelects(); toast('ğŸ—‘ï¸ Tarifa eliminada');
}

function renderTarifas() {
  var ts = getTarifas();
  var cats = {};
  ts.forEach(function(t){
    if (!cats[t.cat]) cats[t.cat] = [];
    cats[t.cat].push(t);
  });
  var html = '';
  Object.keys(cats).forEach(function(cat){
    html += '<div class="tg"><h3>'+CAT_LABELS[cat]+'</h3>';
    cats[cat].forEach(function(t){
      html += '<div class="titem">'+
        '<div style="flex:1"><h4>'+t.nom+'</h4><p>'+t.desc+'</p></div>'+
        '<div style="display:flex;align-items:center;gap:8px;flex-shrink:0">'+
        '<div class="tprice">'+t.precio+'â‚¬</div>'+
        '<button class="btn btn-ro btn-sm" onclick="delTarifa('+t.id+')">âœ•</button>'+
        '</div></div>';
    });
    html += '</div>';
  });
  if (!html) html = '<div class="empty"><div class="ei">ğŸ“‹</div>No hay tarifas. AÃ±ade la primera arriba.</div>';
  document.getElementById('L-tarifas').innerHTML = html;
}

function rebuildPackSelects() {
  var ts = getTarifas().filter(function(t){ return t.cat!=='extras'; });
  var opts = '<option value="0">Sin especificar</option>';
  ts.forEach(function(t){
    opts += '<option value="t'+t.id+'">'+t.nom+' â€“ '+t.precio+'â‚¬</option>';
  });
  opts += '<option value="custom">Otro (manual)</option>';
  ['A_pack','C_pack'].forEach(function(id){
    var el = document.getElementById(id);
    if (el) el.innerHTML = opts;
  });
  // Rebuild PACK_PRICES
  PACK_PRICES = {'custom':0,'0':0};
  ts.forEach(function(t){ PACK_PRICES['t'+t.id] = t.precio; });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SISTEMA DE VOZ CON IA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var vozRecognition = null;
var vozActivo = false;
var vozDatosParsed = null;

function abrirVoz() {
  document.getElementById('voz-instruc').style.display='block';
  document.getElementById('voz-texto-wrap').style.display='none';
  document.getElementById('voz-result-wrap').style.display='none';
  document.getElementById('voz-loading').style.display='none';
  document.getElementById('voz-error').style.display='none';
  document.getElementById('voz-acciones').style.display='none';
  document.getElementById('voz-btn').textContent='ğŸ¤';
  document.getElementById('voz-estado').textContent='PULSA PARA HABLAR';
  document.getElementById('modal-voz').classList.add('on');
}

function toggleVoz() {
  if (vozActivo) {
    pararVoz();
  } else {
    iniciarVoz();
  }
}

function iniciarVoz() {
  var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    document.getElementById('voz-error').textContent='âŒ Tu navegador no soporta voz. Usa Chrome o Safari en iOS.';
    document.getElementById('voz-error').style.display='block';
    return;
  }
  vozRecognition = new SR();
  vozRecognition.lang = 'es-ES';
  vozRecognition.continuous = false;
  vozRecognition.interimResults = true;

  vozActivo = true;
  document.getElementById('voz-btn').textContent='â¹';
  document.getElementById('voz-btn').style.background='var(--ro)';
  document.getElementById('voz-btn').style.borderColor='var(--ro)';
  document.getElementById('voz-estado').textContent='ğŸ”´ ESCUCHANDO... HABLA AHORA';
  document.getElementById('voz-estado').style.color='var(--ro)';
  document.getElementById('voz-instruc').style.display='none';
  document.getElementById('voz-texto-wrap').style.display='block';
  document.getElementById('voz-texto').textContent='...';

  vozRecognition.onresult = function(e) {
    var txt = '';
    for (var i=0; i<e.results.length; i++) txt += e.results[i][0].transcript;
    document.getElementById('voz-texto').textContent = txt;
  };

  vozRecognition.onend = function() {
    vozActivo = false;
    document.getElementById('voz-btn').textContent='ğŸ¤';
    document.getElementById('voz-btn').style.background='var(--s3)';
    document.getElementById('voz-btn').style.borderColor='var(--au)';
    document.getElementById('voz-estado').textContent='PROCESANDO...';
    document.getElementById('voz-estado').style.color='var(--mu)';
    var texto = document.getElementById('voz-texto').textContent;
    if (texto && texto !== '...' && texto.length > 3) {
      procesarVozIA(texto);
    }
  };

  vozRecognition.onerror = function(e) {
    vozActivo = false;
    document.getElementById('voz-btn').textContent='ğŸ¤';
    document.getElementById('voz-btn').style.background='var(--s3)';
    document.getElementById('voz-btn').style.borderColor='var(--au)';
    document.getElementById('voz-error').textContent='âŒ Error: '+e.error+'. Intenta de nuevo.';
    document.getElementById('voz-error').style.display='block';
    document.getElementById('voz-estado').textContent='PULSA PARA HABLAR';
    document.getElementById('voz-estado').style.color='var(--mu)';
  };

  vozRecognition.start();
}

function pararVoz() {
  if (vozRecognition) vozRecognition.stop();
}

/* â”€â”€ PARSER LOCAL DE VOZ (sin API externa, funciona offline) â”€â”€ */
function procesarVozIA(texto) {
  document.getElementById('voz-loading').style.display='block';
  document.getElementById('voz-error').style.display='none';
  document.getElementById('voz-result-wrap').style.display='none';
  document.getElementById('voz-acciones').style.display='none';

  // PequeÃ±o delay para que se vea el spinner
  setTimeout(function(){ vozParsear(texto); }, 300);
}

function vozParsear(txt) {
  var t = txt.toLowerCase();
  var r = {
    accion:'desconocido', nombre:'', telefono:'', servicio:'comunion',
    pack:'', total:0, senal:0, resto:0, fecha:'', hora:'',
    lugar:'', concepto:'', tipo_fin:'ingreso', notas:''
  };

  /* â”€â”€ ACCIÃ“N â”€â”€ */
  if (/cita|sesiÃ³n|sesion|apunt[ao]|reserv/.test(t))       r.accion='cita';
  else if (/cliente|contacto|nuevo/.test(t))               r.accion='cliente';
  else if (/ingreso|cobr[oaÃ©]|pagado|pago|recibi/.test(t)) r.accion='ingreso';
  else if (/gasto|pagu[eÃ©]|compr[eÃ©]|material/.test(t))   r.accion='gasto';
  else if (/nota|recuerda|recordatorio|avisar|aviso|llamar|pendiente/.test(t)) r.accion='nota';
  else if (/seÃ±al|anticipo|depÃ³sito|deposito/.test(t))     { r.accion='ingreso'; r.tipo_fin='senal'; }

  /* â”€â”€ SERVICIO â”€â”€ */
  if (/comuni[oÃ³]n|comunion/.test(t))      r.servicio='comunion';
  else if (/embaraz|maternidad|pregnant/.test(t)) r.servicio='embarazo';
  else if (/bautiz/.test(t))               r.servicio='bautizo';
  else if (/boda|preboda|novia/.test(t))   r.servicio='boda';
  else if (/beb[eÃ©]|reciÃ©n|newborn/.test(t)) r.servicio='bebes';
  else if (/navidad|christmas/.test(t))    r.servicio='navidad';

  /* â”€â”€ PACK â”€â”€ */
  if (/bronce/.test(t))      r.pack='Pack Bronce';
  else if (/plata/.test(t))  r.pack='Pack Plata';
  else if (/oro/.test(t))    r.pack='Pack Oro';
  else if (/recuerdo/.test(t)) r.pack='Pack Recuerdo';
  else if (/historia/.test(t)) r.pack='Pack Historia';
  else if (/esencial/.test(t)) r.pack='Pack Esencial';
  else if (/celebraci/.test(t)) r.pack='Pack CelebraciÃ³n';

  /* â”€â”€ TELÃ‰FONO â”€â”€ */
  var telM = txt.match(/\b([6-9]\d{8})\b|\b(\d{3}[\s-]\d{3}[\s-]\d{3})\b/);
  if (telM) r.telefono = (telM[1]||telM[2]).replace(/[\s-]/g,'');

  /* â”€â”€ IMPORTES â”€â”€ */
  // "seÃ±al de 60", "60 euros de seÃ±al", "total 145", "cobrado 90"
  var mSenal = t.match(/se[Ã±n]al(?:[^0-9]{0,10})(\d+(?:[,.]\d+)?)|(\d+(?:[,.]\d+)?)\s*(?:euros?\s*)?(?:de\s*)?se[Ã±n]al/);
  if (mSenal) r.senal = parseFloat((mSenal[1]||mSenal[2]).replace(',','.'));

  var mTotal = t.match(/total\s+(?:de\s+)?(\d+(?:[,.]\d+)?)|(\d+(?:[,.]\d+)?)\s*euros?\s*(?:en\s*total|de\s*total)/);
  if (mTotal) r.total = parseFloat((mTotal[1]||mTotal[2]).replace(',','.'));

  // Si solo se menciona un importe suelto sin contexto de seÃ±al/total
  if (!r.total && !r.senal) {
    var mImp = t.match(/(\d+(?:[,.]\d+)?)\s*(?:euro|â‚¬)/);
    if (mImp) {
      var imp = parseFloat(mImp[1].replace(',','.'));
      if (r.accion==='ingreso' || r.accion==='gasto') r.total = imp;
      else r.senal = imp;
    }
  }
  if (r.total && r.senal) r.resto = Math.max(0, r.total - r.senal);
  if (!r.total && r.senal) r.total = r.senal; // solo seÃ±al â†’ total = seÃ±al

  /* â”€â”€ FECHA â”€â”€ */
  var now = new Date();
  var y = now.getFullYear();
  var MESES = {enero:1,febrero:2,marzo:3,abril:4,mayo:5,junio:6,
               julio:7,agosto:8,septiembre:9,octubre:10,noviembre:11,diciembre:12};
  // "el 15 de marzo", "15 marzo", "dÃ­a 15 de marzo"
  var mFecha = t.match(/(?:el\s+|dÃ­a\s+)?(\d{1,2})\s+de\s+([a-z]+)/);
  if (!mFecha) mFecha = t.match(/(\d{1,2})\s+(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre)/);
  if (mFecha) {
    var dia = parseInt(mFecha[1]);
    var mes = MESES[mFecha[2]];
    if (mes) {
      var fy = y; if (mes < now.getMonth()+1) fy = y+1; // si pasÃ³ este aÃ±o â†’ siguiente
      r.fecha = fy+'-'+String(mes).padStart(2,'0')+'-'+String(dia).padStart(2,'0');
    }
  }
  if (/maÃ±ana/.test(t)) {
    var m2 = new Date(now); m2.setDate(m2.getDate()+1);
    r.fecha = m2.toISOString().split('T')[0];
  }
  if (/hoy/.test(t) && !r.fecha) r.fecha = hoy();
  if (!r.fecha) r.fecha = hoy();

  /* â”€â”€ HORA â”€â”€ */
  // "a las 10", "a las 10 y media", "a las 10:30", "10 de la maÃ±ana", "17 horas"
  var mHora = t.match(/a las\s+(\d{1,2})(?::(\d{2}))?\s*(?:y media)?|(\d{1,2})\s*(?:de la\s*)?(maÃ±ana|tarde|noche)|(\d{1,2}):(\d{2})/);
  if (mHora) {
    var h2=0, min2=0;
    if (mHora[5]) { h2=parseInt(mHora[5]); min2=parseInt(mHora[6]); }
    else if (mHora[3]) {
      h2=parseInt(mHora[3]);
      if (mHora[4]==='tarde'&&h2<12) h2+=12;
      if (mHora[4]==='noche'&&h2<12) h2+=12;
      if (mHora[4]==='maÃ±ana'&&h2===12) h2=0;
    } else if (mHora[1]) {
      h2=parseInt(mHora[1]);
      if (/y media/.test(t.slice(t.indexOf(mHora[0])))) min2=30;
    }
    r.hora = String(h2).padStart(2,'0')+':'+String(min2).padStart(2,'0');
  }

  /* â”€â”€ NOMBRE â”€â”€ */
  // Buscar "para X", "de X", "cliente X" seguido de palabras capitalizadas
  var nomM = txt.match(/(?:para|cliente|cita para|de|cobro de|seÃ±al de|sesiÃ³n de|sesion de)\s+([A-ZÃÃ‰ÃÃ“ÃšÃ‘][a-zÃ¡Ã©Ã­Ã³ÃºÃ±]+(?:\s+[A-ZÃÃ‰ÃÃ“ÃšÃ‘][a-zÃ¡Ã©Ã­Ã³ÃºÃ±]+)*)/);
  if (nomM) r.nombre = nomM[1];
  // Fallback: primera secuencia de palabras capitalizadas
  if (!r.nombre) {
    var nomFb = txt.match(/([A-ZÃÃ‰ÃÃ“ÃšÃ‘][a-zÃ¡Ã©Ã­Ã³ÃºÃ±]+(?:\s+[A-ZÃÃ‰ÃÃ“ÃšÃ‘][a-zÃ¡Ã©Ã­Ã³ÃºÃ±]+)+)/);
    if (nomFb) r.nombre = nomFb[1];
  }

  /* â”€â”€ LUGAR â”€â”€ */
  var lugM = t.match(/en\s+(?:el\s+|la\s+)?([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+?)(?:\s*,|\s+a las|\s+el\s+\d|$)/);
  if (lugM && lugM[1].length>3 && !/comunion|embaraz|bautiz|boda|plata|bronce|oro/.test(lugM[1])) {
    r.lugar = lugM[1].trim();
  }

  /* â”€â”€ CONCEPTO para ingresos/gastos â”€â”€ */
  if (r.accion==='ingreso'||r.accion==='gasto') {
    r.concepto = txt.length > 60 ? txt.slice(0,60)+'â€¦' : txt;
  }

  /* â”€â”€ NOTAS (texto completo) â”€â”€ */
  r.notas = txt;

  /* â”€â”€ MOSTRAR RESULTADO â”€â”€ */
  document.getElementById('voz-loading').style.display='none';

  var ACCION_LBL = {cita:'ğŸ“… Nueva cita',cliente:'ğŸ‘¤ Nuevo cliente',ingreso:'ğŸ’š Ingreso',gasto:'ğŸ”´ Gasto',nota:'ğŸ“ Nota/Recordatorio',desconocido:'â“ No reconocido'};
  var html = '<div style="margin-bottom:4px"><b>AcciÃ³n:</b> '+(ACCION_LBL[r.accion]||'?')+'</div>';
  if (r.nombre)    html += '<div><b>Cliente:</b> '+r.nombre+'</div>';
  if (r.telefono)  html += '<div><b>Tel:</b> '+r.telefono+'</div>';
  if (r.servicio && r.accion!=='ingreso'&&r.accion!=='gasto'&&r.accion!=='nota') html += '<div><b>Servicio:</b> '+svcL(r.servicio)+'</div>';
  if (r.pack)      html += '<div><b>Pack:</b> '+r.pack+'</div>';
  if (r.total>0)   html += '<div><b>Total:</b> '+r.total+'â‚¬</div>';
  if (r.senal>0)   html += '<div><b>SeÃ±al:</b> '+r.senal+'â‚¬</div>';
  if (r.resto>0)   html += '<div><b>Resto pendiente:</b> '+r.resto+'â‚¬</div>';
  if (r.fecha)     html += '<div><b>Fecha:</b> '+fmtD(r.fecha)+'</div>';
  if (r.hora)      html += '<div><b>Hora:</b> '+r.hora+'</div>';
  if (r.lugar)     html += '<div><b>Lugar:</b> '+r.lugar+'</div>';
  if (r.concepto && (r.accion==='ingreso'||r.accion==='gasto')) html += '<div><b>Concepto:</b> '+r.concepto+'</div>';

  // Si no detectÃ³ nada Ãºtil
  if (r.accion==='desconocido') {
    document.getElementById('voz-error').textContent='No he entendido bien. Intenta decir: "Cita para [nombre], comuniÃ³n, el [dÃ­a] de [mes] a las [hora]"';
    document.getElementById('voz-error').style.display='block';
    document.getElementById('voz-loading').style.display='none';
    return;
  }

  vozDatosParsed = r;
  document.getElementById('voz-result').innerHTML = html;
  document.getElementById('voz-result-wrap').style.display='block';
  document.getElementById('voz-acciones').style.display='flex';
  document.getElementById('voz-estado').textContent='REVISA Y CONFIRMA';
}

function vozAceptar() {
  var r = vozDatosParsed;
  if (!r) return;

  if (r.accion === 'cita') {
    var total = r.total||0, senal = r.senal||0, resto = Math.max(0,total-senal);
    DB.citas.push({ id:uid(), nombre:r.nombre||'Sin nombre',
      tel:r.telefono||'', tipo:r.servicio||'comunion', pack:r.pack||'',
      total:total, senal:senal, resto:resto,
      fecha:r.fecha||hoy(), hora:r.hora||'', lugar:r.lugar||'', notas:r.notas||'' });
    autoFin(r.nombre||'Sin nombre', svcL(r.servicio||'comunion'), total, senal, resto);
    saveDB(); renderAll(); closeModal('modal-voz');
    toast('âœ… Cita creada por voz');
    go('agenda', document.querySelectorAll('.tab')[1]);

  } else if (r.accion === 'cliente') {
    var total = r.total||0, senal = r.senal||0, resto = Math.max(0,total-senal);
    DB.clientes.push({ id:uid(), nombre:r.nombre||'Sin nombre',
      tel:r.telefono||'', tipo:r.servicio||'comunion', pack:r.pack||'',
      total:total, senal:senal, resto:resto, notas:r.notas||'', fecha:hoy() });
    autoFin(r.nombre||'Sin nombre', svcL(r.servicio||'comunion'), total, senal, resto);
    saveDB(); renderAll(); closeModal('modal-voz');
    toast('âœ… Cliente creado por voz');
    go('clientes', document.querySelectorAll('.tab')[3]);

  } else if (r.accion === 'ingreso' || r.accion === 'gasto') {
    var imp = r.total||r.senal||0;
    if (imp > 0) {
      DB.fin.push({ id:uid(), tipo:r.tipo_fin||r.accion,
        imp:imp, concepto:r.concepto||r.notas||'Voz',
        fecha:r.fecha||hoy(), cliente:r.nombre||'' });
      saveDB(); renderAll(); closeModal('modal-voz');
      toast('âœ… Movimiento registrado por voz');
      go('finanzas', document.querySelectorAll('.tab')[2]);
    }

  } else if (r.accion === 'nota') {
    DB.notas.push({ id:uid(), tit:r.nombre||r.concepto||r.notas||'Recordatorio voz',
      desc:r.notas||'', fecha:r.fecha||hoy(), hora:r.hora||'',
      prio:'media', estado:'pend', alarmFired:false });
    saveDB(); renderAll(); closeModal('modal-voz');
    toast('âœ… Nota creada por voz');
    go('notas', document.querySelectorAll('.tab')[4]);
  }
  vozDatosParsed = null;
}

function vozRechazar() {
  vozDatosParsed = null;
  document.getElementById('voz-result-wrap').style.display='none';
  document.getElementById('voz-acciones').style.display='none';
  document.getElementById('voz-instruc').style.display='block';
  document.getElementById('voz-texto-wrap').style.display='none';
  document.getElementById('voz-estado').textContent='PULSA PARA HABLAR';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SERVICE WORKER + PWA INSTALL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function registrarSW() {
  if (!('serviceWorker' in navigator)) return;
  navigator.serviceWorker.register('/sw.js').then(function(reg) {
    console.log('SW registrado:', reg.scope);
    // Pedir permiso de notificaciones
    if ('Notification' in window && Notification.permission === 'default') {
      // Pedimos permiso la primera vez que el usuario interactÃºa
      document.body.addEventListener('click', function pedirPermiso() {
        Notification.requestPermission();
        document.body.removeEventListener('click', pedirPermiso);
      }, { once: true });
    }
  }).catch(function(e) { console.log('SW error:', e); });
}

/* Programa alarmas pendientes en el SW para que suenen con la app cerrada */
function programarAlarmasSW() {
  if (!('serviceWorker' in navigator) || !navigator.serviceWorker.controller) return;
  var h = hoy();
  DB.notas.forEach(function(n) {
    if (n.estado === 'hecha' || n.alarmFired || !n.fecha || !n.hora) return;
    if (n.fecha >= h) {
      navigator.serviceWorker.controller.postMessage({
        type: 'SCHEDULE_ALARM',
        alarm: { id: n.id, tit: n.tit, desc: n.desc || '', fecha: n.fecha, hora: n.hora }
      });
    }
  });
}

/* Banner de instalaciÃ³n PWA */
var deferredInstallPrompt = null;
window.addEventListener('beforeinstallprompt', function(e) {
  e.preventDefault();
  deferredInstallPrompt = e;
  // Mostrar botÃ³n de instalar en el header
  var btn = document.getElementById('install-btn');
  if (btn) btn.style.display = 'flex';
});

function instalarPWA() {
  if (!deferredInstallPrompt) return;
  deferredInstallPrompt.prompt();
  deferredInstallPrompt.userChoice.then(function(r) {
    if (r.outcome === 'accepted') {
      toast('âœ… Â¡App instalada en tu escritorio!');
      document.getElementById('install-btn').style.display = 'none';
    }
    deferredInstallPrompt = null;
  });
}

window.addEventListener('appinstalled', function() {
  toast('âœ… Â¡App instalada correctamente!');
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ARRANQUE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
init();
registrarSW();
setTimeout(programarAlarmasSW, 1500); // Esperar a que el SW estÃ© listo
</script>
</body>
</html>
